<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NexScore Judge Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* HIGH CONTRAST DARK MODE PALETTE */
            --bg: #020617;
            --panel: #0f172a;
            --panel2: #1e293b;
            --accent: #38bdf8;
            --accent-text: #000000;
            --border: #334155;
            --input-bg: #020617;
            --input-text: #ffffff;
            --ok: #4ade80;
            --err: #f87171;
            --warn: #facc15;
            --text: #ffffff;
            --text-muted: #cbd5e1;
            --text-header: #ffffff;
            --shadow-header: 0 2px 4px rgba(0,0,0,0.8);
            /* SIZING */
            --banner-height: 180px;
            --banner-blur: 4px;
            --fs-body: 18px;
            --fs-small: 16px;
            --fs-label: 20px;
            --fs-button: 18px;
            --fs-h1: 40px;
            --fs-judge: 22px;
            --fs-phase-label: 22px;
            --fs-segment: 16px;
            --fs-candidate-name: 26px;
            --fs-crit-title: 20px;
            --fs-crit-weight: 15px;
            --fs-table-h: 18px;
            --fs-table-cell: 18px;
            --fs-input-score: 24px;
        }

        /* LIGHT MODE OVERRIDES */
        body.light-mode {
            --bg: #f8fafc;
            --panel: #ffffff;
            --panel2: #f1f5f9;
            --accent: #0ea5e9;
            --accent-text: #ffffff;
            --border: #cbd5e1;
            --input-bg: #ffffff;
            --input-text: #0f172a;
            --text: #0f172a;
            --text-muted: #64748b;
            --text-header: #0f172a;
            --shadow-header: none;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Lexend Deca', Segoe UI, Arial, sans-serif;
            font-size: var(--fs-body);
            background: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 340px;
            background: var(--panel);
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }

            .sidebar h2 {
                margin: 0 0 20px;
                font-size: var(--fs-label);
                font-weight: 700;
                text-align: center;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--accent);
            }

        .candidate-item {
            padding: 14px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 12px;
            background: var(--panel2);
            border: 1px solid var(--border);
            font-size: var(--fs-small);
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text);
        }

            .candidate-item:hover {
                border-color: var(--accent);
                filter: brightness(1.05);
            }

            .candidate-item.active {
                background: var(--accent);
                color: var(--accent-text);
                font-weight: 700;
                border-color: var(--accent);
                box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
            }

        /* --- MAIN LAYOUT --- */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .banner-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: var(--banner-height);
            background: #20253d;
            overflow: hidden;
            z-index: 0;
        }

            .banner-bg img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
                filter: blur(var(--banner-blur)) brightness(0.6);
            }

        .banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: var(--banner-height);
            background: linear-gradient(to bottom, rgba(0,0,0, 0.5), rgba(0,0,0, 0.2) 60%, var(--bg) 100%);
            z-index: 1;
            pointer-events: none;
        }

        .header {
            position: relative;
            z-index: 2;
            text-align: center;
            padding: 40px 20px 20px;
            min-height: var(--banner-height);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            text-shadow: var(--shadow-header);
        }

            .header h1 {
                margin: 0;
                font-size: var(--fs-h1);
                font-weight: 700;
                letter-spacing: .6px;
                color: var(--text-header);
                transition: color 0.3s;
            }

            .header .judge-line {
                margin-top: 10px;
                font-size: var(--fs-judge);
                font-weight: 500;
                color: var(--accent);
            }

        .warn {
            color: var(--warn);
            font-size: var(--fs-small);
            margin-top: 10px;
            font-weight: 700;
            background: rgba(250, 204, 21, 0.1);
            padding: 5px;
            border-radius: 4px;
            display: inline-block;
        }

        .theme-toggle-btn {
            position: absolute;
            top: 20px;
            right: 24px;
            z-index: 100;
            background: var(--panel2);
            color: var(--text);
            border: 2px solid var(--border);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

            .theme-toggle-btn:hover {
                transform: scale(1.1);
                border-color: var(--accent);
            }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px 60px;
            z-index: 2;
        }

        /* --- CONTROLS --- */
        .phase-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 0 0 30px;
            flex-wrap: wrap;
        }

        .phase-btn {
            background: var(--panel2);
            color: var(--text);
            border: 2px solid var(--border);
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 700;
            font-size: 24px;
            min-width: 80px;
            transition: .2s all;
        }

            .phase-btn:hover:not(:disabled) {
                filter: brightness(1.1);
                border-color: var(--accent);
            }

            .phase-btn:disabled {
                opacity: 0.3;
                cursor: not-allowed;
                border-color: transparent;
            }

        .phase-label {
            font-size: var(--fs-phase-label);
            font-weight: 700;
            padding: 14px 28px;
            background: var(--panel2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-align: center;
            min-width: 320px;
            letter-spacing: .5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .segment-label {
            font-size: var(--fs-segment);
            color: var(--text-muted);
            text-align: center;
            margin-top: 8px;
            font-weight: 500;
        }

        /* --- CANDIDATE DETAILS --- */
        .candidate-details {
            background: var(--panel);
            padding: 24px;
            border-radius: 16px;
            display: flex;
            gap: 28px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            transition: background 0.3s;
        }

        .cand-photo-box {
            width: 160px;
            height: 210px;
            background: #000;
            border-radius: 12px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #cbd5e1;
            overflow: hidden;
            flex-shrink: 0;
        }

            .cand-photo-box img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        .cand-info {
            flex: 1;
            min-width: 280px;
        }

            .cand-info h3 {
                margin: 0 0 10px;
                font-size: var(--fs-candidate-name);
                font-weight: 700;
                color: var(--accent);
            }

        .cand-meta {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 8px 16px;
            font-size: var(--fs-small);
            margin-top: 8px;
        }

            .cand-meta div:nth-child(odd) {
                color: var(--text-muted);
                font-weight: 400;
            }

            .cand-meta div:nth-child(even) {
                font-weight: 600;
                font-size: 110%;
                color: var(--text);
            }

        /* --- CRITERIA SECTION --- */
        .criteria-section {
            background: var(--panel);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 32px;
            border: 1px solid var(--border);
        }

            .criteria-section h2 {
                margin: 0 0 20px;
                font-size: 26px;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 16px;
                flex-wrap: wrap;
                color: var(--text);
            }

                .criteria-section h2 .progress {
                    font-size: 14px;
                    font-weight: 600;
                    background: var(--panel2);
                    border: 1px solid var(--border);
                    color: var(--accent);
                    padding: 6px 14px;
                    border-radius: 30px;
                }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .crit-card {
            background: var(--panel2);
            padding: 18px;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

            .crit-card h4 {
                margin: 0;
                font-size: var(--fs-crit-title);
                font-weight: 600;
                line-height: 1.3;
                color: var(--text);
            }

        .crit-weight {
            font-size: var(--fs-crit-weight);
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .crit-card input {
            padding: 12px 14px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: var(--input-bg);
            color: var(--input-text);
            font-size: var(--fs-input-score);
            font-weight: 700;
            width: 100%;
            transition: border-color 0.2s;
        }

            .crit-card input:focus {
                outline: none;
                border-color: var(--accent);
                box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.2);
            }

            .crit-card input::placeholder {
                color: var(--text-muted);
                font-weight: 400;
                font-size: 18px;
            }

        .crit-card button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: var(--accent-text);
            font-weight: 700;
            font-size: var(--fs-button);
            cursor: pointer;
            transition: .2s background;
            margin-top: 4px;
        }

            .crit-card button:hover {
                filter: brightness(1.1);
            }

            .crit-card button:disabled {
                opacity: 0.5;
                cursor: wait;
            }

        .crit-status {
            min-height: 20px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: .3px;
            margin-top: 4px;
        }

            .crit-status.ok {
                color: var(--ok);
            }

            .crit-status.err {
                color: var(--err);
            }

            .crit-status.dirty {
                color: var(--warn);
            }

        /* --- SCORE TABLE --- */
        .scores-section {
            background: var(--panel);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

            .scores-section h2 {
                margin: 0 0 20px;
                font-size: 26px;
                font-weight: 700;
                color: var(--text);
            }

        .scores-actions {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

            .scores-actions button {
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                background: var(--panel2);
                border: 2px solid var(--border);
                color: var(--text);
                font-weight: 600;
                font-size: 16px;
                cursor: pointer;
                transition: .2s all;
            }

                .scores-actions button:hover {
                    border-color: var(--accent);
                    filter: brightness(0.95);
                }

                .scores-actions button.btn-print {
                    background: #8b5cf6;
                    color: #fff;
                    border-color: #7c3aed;
                }

                    .scores-actions button.btn-print:hover {
                        background: #7c3aed;
                        border-color: #6d28d9;
                    }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 14px 16px;
            font-size: var(--fs-table-cell);
            border-bottom: 1px solid var(--border);
            text-align: left;
            white-space: nowrap;
            color: var(--text);
        }

        th {
            background: var(--panel2);
            font-size: var(--fs-table-h);
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr:nth-child(even) {
            background-color: rgba(125, 125, 125, 0.05);
        }

        /* --- TOOLS BAR --- */
        .sticky-tools {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--panel);
            padding: 12px 0;
            margin: -24px -24px 20px;
            padding-left: 24px;
            padding-right: 24px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 2px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mini-btn {
            background: var(--bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
        }

            .mini-btn:hover {
                background: var(--panel2);
                color: var(--text);
                border-color: var(--accent);
            }

        /* PRINT STYLES - ADMIN SCORECARD STYLE */
        .print-container {
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .print-container, .print-container * {
                visibility: visible;
            }

            .print-container {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                background: white;
                color: black;
                font-size: 11pt;
                padding: 20px;
            }

                .print-container h1 {
                    font-size: 24pt;
                    margin: 0 0 10px;
                    color: black;
                }

                .print-container h2 {
                    font-size: 14pt;
                    margin: 0 0 20px;
                    font-weight: normal;
                    color: black;
                }

            /* Main Admin Table Style */
            .admin-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }

                .admin-table th, .admin-table td {
                    border-bottom: 1px solid #ccc;
                    padding: 10px 8px;
                    text-align: left;
                    vertical-align: top;
                }

                .admin-table th {
                    background-color: #f0f0f0;
                    font-weight: bold;
                    border-top: 1px solid #000;
                    border-bottom: 2px solid #000;
                }

                .admin-table tr:last-child td {
                    border-bottom: 2px solid #000;
                }

            /* Sub Table (Details) Style */
            .sub-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 5px;
                font-size: 10pt;
            }

                .sub-table th, .sub-table td {
                    border: none;
                    border-bottom: 1px solid #eee;
                    padding: 4px 6px;
                    color: #333;
                }

                .sub-table th {
                    font-weight: 600;
                    color: #000;
                    text-transform: uppercase;
                    font-size: 9pt;
                }

                .sub-table td.score-cell {
                    font-weight: bold;
                    text-align: right;
                }
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            body {
                flex-direction: column;
            }

            .header {
                min-height: auto;
                padding: 20px;
            }

            .content {
                padding: 20px;
            }

            .crit-card input {
                font-size: 20px;
            }

            .theme-toggle-btn {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Contestants</h2>
        <div id="candidateList"></div>
    </div>

    <div id="printArea" class="print-container"></div>

    <div class="main">
        <button id="btnToggleTheme" class="theme-toggle-btn" title="Toggle Theme">‚òÄÔ∏è</button>
        <div class="banner-bg" id="bannerBg" style="display:none;"></div>
        <div class="banner-overlay" id="bannerOverlay" style="display:none;"></div>

        <div class="header">
            <h1 id="eventTitle">Event: ‚Äî</h1>
            <div id="judgeLine" class="judge-line">Judge: ‚Äî</div>
            <div id="idWarning" class="warn" style="display:none;">Missing judge identity.</div>
        </div>

        <div class="content">
            <div class="phase-nav">
                <button id="btnPrevPhase" class="phase-btn">&#9664;</button>
                <div>
                    <div id="phaseLabel" class="phase-label">Phase ‚Äî / Segment ‚Äî</div>
                    <div id="segmentLabel" class="segment-label"></div>
                </div>
                <button id="btnNextPhase" class="phase-btn">&#9654;</button>
            </div>

            <div id="candidateDetails" class="candidate-details" style="display:none;">
                <div class="cand-photo-box" id="candPhotoBox" style="display:none;"></div>
                <div class="cand-info">
                    <h3 id="candName">‚Äî</h3>
                    <div class="cand-meta">
                        <div>Number:</div><div id="candNumber">‚Äî</div>
                        <div>Age:</div><div id="candAge">‚Äî</div>
                        <div>Gender:</div><div id="candGender">‚Äî</div>
                        <div>Representing:</div><div id="candRep">‚Äî</div>
                    </div>
                </div>
            </div>

            <div class="criteria-section">
                <h2>
                    Criteria
                    <span class="progress" id="criteriaProgress">0 / 0 saved</span>
                </h2>
                <div class="sticky-tools">
                    <button class="mini-btn" id="btnRestoreLocal">Restore Local</button>
                    <button class="mini-btn" id="btnClearLocal">Clear Local</button>
                    <button class="mini-btn" id="btnReloadRemote">Reload Remote</button>
                </div>
                <div id="criteriaGrid" class="criteria-grid"></div>
            </div>

            <div class="scores-section">
                <h2>My Scores</h2>
                <div class="scores-actions">
                    <button id="btnRefreshScores">Refresh</button>
                    <button id="btnForceSync">Force Sync</button>
                    <button id="btnPrint" class="btn-print">Print</button>
                </div>
                <table>
                    <thead><tr><th>Rank</th><th>Contestant</th><th>Total %</th></tr></thead>
                    <tbody id="scoresBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        (function () {
            // Theme Logic
            const btnToggleTheme = document.getElementById('btnToggleTheme');
            function updateThemeIcon(isLight) { btnToggleTheme.textContent = isLight ? 'üåô' : '‚òÄÔ∏è'; }
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') { document.body.classList.add('light-mode'); updateThemeIcon(true); } else { updateThemeIcon(false); }
            btnToggleTheme.onclick = () => {
                document.body.classList.toggle('light-mode');
                const isLight = document.body.classList.contains('light-mode');
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
                updateThemeIcon(isLight);
            };

            const qs = new URLSearchParams(location.search);
            let eventId = qs.get('eventId') || localStorage.getItem('eventId') || '';
            let judgeId = qs.get('judgeId') || localStorage.getItem('judgeId') || '';
            if (qs.get('eventId')) localStorage.setItem('eventId', qs.get('eventId'));
            if (qs.get('judgeId')) localStorage.setItem('judgeId', qs.get('judgeId'));

            const idWarning = document.getElementById('idWarning');
            if (!eventId || !judgeId) { idWarning.style.display = 'block'; return; }

            // DOM refs
            const eventTitle = document.getElementById('eventTitle');
            const judgeLine = document.getElementById('judgeLine');
            const candidateListDiv = document.getElementById('candidateList');
            const candDetails = document.getElementById('candidateDetails');
            const candPhotoBox = document.getElementById('candPhotoBox');
            const candNameEl = document.getElementById('candName');
            const candNumberEl = document.getElementById('candNumber');
            const candAgeEl = document.getElementById('candAge');
            const candGenderEl = document.getElementById('candGender');
            const candRepEl = document.getElementById('candRep');
            const criteriaGrid = document.getElementById('criteriaGrid');
            const scoresBody = document.getElementById('scoresBody');
            const btnRefreshScores = document.getElementById('btnRefreshScores');
            const btnForceSync = document.getElementById('btnForceSync');
            const btnPrevPhase = document.getElementById('btnPrevPhase');
            const btnNextPhase = document.getElementById('btnNextPhase');
            const phaseLabel = document.getElementById('phaseLabel');
            const segmentLabel = document.getElementById('segmentLabel');
            const bannerBg = document.getElementById('bannerBg');
            const bannerOverlay = document.getElementById('bannerOverlay');
            const criteriaProgress = document.getElementById('criteriaProgress');
            const btnRestoreLocal = document.getElementById('btnRestoreLocal');
            const btnClearLocal = document.getElementById('btnClearLocal');
            const btnReloadRemote = document.getElementById('btnReloadRemote');
            const printArea = document.getElementById('printArea');

            // State
            let judges = [], contestants = [], structure = { phases: [] };
            let phaseSegments = [];
            let currentIndex = 0;
            let activeContestantId = null;
            let scoreCache = {};
            let dirtySet = new Set();
            let inFlight = new Set();
            let judgeDisplayName = '';
            let rankedData = []; // Store ranking from refreshScoresTable

            // Helpers
            async function api(path, opts = {}) {
                const r = await fetch(path, opts);
                let data;
                try { data = await r.json(); } catch { data = null; }
                if (!r.ok && r.status !== 409) {
                    const msg = data && (data.message || data.error) ? (data.message || data.error) : (r.status + ' ' + r.statusText);
                    throw new Error(msg);
                }
                return { ok: r.ok || r.status === 409, status: r.status, data };
            }
            const pick = (o, ...names) => { for (const n of names) if (o && n in o) return o[n]; };
            const canonicalPhaseKey = p => (p || '').toLowerCase();
            const buildCriteriaKey = (phaseKey, segSeq, critName) =>
                `${canonicalPhaseKey(phaseKey)}::${segSeq}:${(critName || '').trim().toLowerCase()}`;

            function localKey(contestantId, criteriaKey) {
                return `score:${eventId}:${judgeId}:${contestantId}:${criteriaKey}`;
            }

            function saveLocal(contestantId, criteriaKey, value) {
                localStorage.setItem(localKey(contestantId, criteriaKey), String(value));
            }

            function getLocal(contestantId, criteriaKey) {
                const v = localStorage.getItem(localKey(contestantId, criteriaKey));
                if (v == null) return null;
                const num = parseFloat(v);
                return isNaN(num) ? null : num;
            }

            function updateProgress() {
                if (!activeContestantId) { criteriaProgress.textContent = '0 / 0 saved'; return; }
                const cards = [...criteriaGrid.querySelectorAll('.crit-card')];
                let total = cards.length;
                let saved = 0;
                cards.forEach(card => {
                    const status = card.querySelector('.crit-status');
                    if (status && status.classList.contains('ok')) saved++;
                });
                criteriaProgress.textContent = `${saved} / ${total} saved`;
            }

            // --- ADMIN-STYLE PRINT FUNCTION ---
            document.getElementById('btnPrint').onclick = async () => {
                // Ensure latest scores are loaded
                await refreshScoresTable(); // Updates rankedData

                let html = `<h1>${judgeDisplayName || 'Judge'}</h1>`;
                html += `<h2>${eventTitle.textContent.replace('Event: ', '')}</h2>`;

                // MAIN TABLE - Replicating Admin Scorecard Format
                html += `<table class="admin-table">`;
                html += `<thead><tr>
                                <th style="width:50px;">Rank</th>
                                <th style="width:50px;">No.</th>
                                <th style="width:200px;">Contestant</th>
                                <th style="width:80px;">Total %</th>
                                <th>Details</th>
                             </tr></thead><tbody>`;

                // If no ranked data, fallback to regular list
                let listToPrint = rankedData.length > 0 ? rankedData : contestants.map(c => ({ contestantId: c.id, totalFraction: 0 }));

                let rank = 1;
                listToPrint.forEach(item => {
                    const c = contestants.find(x => x.id === item.contestantId);
                    if (!c) return;

                    const pct = (Number(item.totalFraction || 0) * 100).toFixed(3);
                    const cScores = scoreCache[c.id] || {};

                    html += `<tr>`;
                    html += `<td>${rank++}</td>`;
                    html += `<td>${c.number}</td>`;
                    html += `<td><b>${escapeHtml(c.fullName)}</b></td>`;
                    html += `<td>${pct}</td>`;

                    // NESTED DETAILS TABLE
                    html += `<td><table class="sub-table">`;
                    html += `<thead><tr><th>Phase</th><th>Segment</th><th>Criteria</th><th style="text-align:right;">Score</th></tr></thead><tbody>`;

                    phaseSegments.forEach(ps => {
                        const phName = ps.phase.name || 'Phase';
                        const segName = ps.segment.name || 'Segment';
                        (ps.segment.criteria || []).forEach(crit => {
                            const key = buildCriteriaKey(ps.phase.key, ps.segment.sequence, crit.name);
                            let val = cScores[key];
                            if (val == null) val = getLocal(c.id, key); // Fallback to local

                            html += `<tr>`;
                            html += `<td>${escapeHtml(phName)}</td>`;
                            html += `<td>${escapeHtml(segName)}</td>`;
                            html += `<td>${escapeHtml(crit.name)}</td>`;
                            html += `<td class="score-cell">${val != null ? val : '-'}</td>`;
                            html += `</tr>`;
                        });
                    });

                    html += `</tbody></table></td>`;
                    html += `</tr>`;
                });

                html += `</tbody></table>`;

                // Signature
                html += `<div style="margin-top: 50px; page-break-inside: avoid;">
                                <div style="border-top: 1px solid black; width: 300px; padding-top: 5px;">
                                    <b>Signature:</b> ${judgeDisplayName}
                                </div>
                             </div>`;

                printArea.innerHTML = html;
                window.print();
            };

            async function loadEvent() {
                try {
                    const { data: e } = await api(`/api/event?eventId=${encodeURIComponent(eventId)}`);
                    const name = e?.EventName || e?.eventName || e?.Title || e?.Name || eventId;
                    eventTitle.textContent = 'Event: ' + name;
                    if (e?.BannerPath || e?.bannerPath) {
                        const img = document.createElement('img');
                        img.src = `/api/event-banner?eventId=${encodeURIComponent(eventId)}`;
                        img.onload = () => {
                            if (img.naturalWidth <= 2 && img.naturalHeight <= 2) {
                                bannerBg.style.display = 'none';
                                bannerOverlay.style.display = 'none';
                            } else {
                                bannerBg.style.display = 'block';
                                bannerOverlay.style.display = 'block';
                                bannerBg.innerHTML = '';
                                bannerBg.appendChild(img);
                            }
                        };
                        img.onerror = () => {
                            bannerBg.style.display = 'none';
                            bannerOverlay.style.display = 'none';
                        };
                    }
                } catch {
                    eventTitle.textContent = 'Event: ' + eventId;
                }
            }

            async function loadJudges() {
                try {
                    const { data: list } = await api(`/api/judges?eventId=${encodeURIComponent(eventId)}`);
                    judges = list || [];
                    const j = judges.find(j =>
                        (j.judgeId || j.JudgeId) === judgeId ||
                        (j.id || j.Id) === judgeId
                    );

                    if (j) {
                        const title = j.Title || j.title || '';
                        const name = j.Name || j.name || '(Unnamed)';
                        judgeDisplayName = `${title ? title + ' ' : ''}${name}`;
                        judgeLine.textContent = `Judge: ${judgeDisplayName}`;
                    } else {
                        judgeLine.textContent = 'Judge: (Unknown)';
                    }
                } catch {
                    judgeLine.textContent = 'Judge: ' + judgeId;
                }
            }

            async function loadContestants() {
                try {
                    const { data: list } = await api(`/api/contestants?eventId=${encodeURIComponent(eventId)}`);
                    contestants = (list || []).map(c => ({
                        id: pick(c, 'id', 'Id'),
                        number: pick(c, 'number', 'Number'),
                        fullName: pick(c, 'fullName', 'FullName') || '',
                        representing: pick(c, 'representing', 'Representing') || '',
                        gender: (pick(c, 'gender', 'Gender') || '').toLowerCase(),
                        age: pick(c, 'age', 'Age'),
                        photoPath: pick(c, 'photoPath', 'PhotoPath') || '',
                        isActive: c.isActive !== false
                    }));
                    renderContestantSidebar();
                } catch {
                    candidateListDiv.innerHTML = '<div style="opacity:.7;">Error loading contestants</div>';
                }
            }

            function renderContestantSidebar() {
                candidateListDiv.innerHTML = '';
                contestants.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'candidate-item';
                    div.dataset.id = c.id;
                    div.textContent = `#${c.number} ${c.fullName}`;
                    div.onclick = () => selectContestant(c.id);
                    candidateListDiv.appendChild(div);
                });
                if (!activeContestantId && contestants.length) {
                    selectContestant(contestants[0].id);
                } else highlightContestant();
            }
            function highlightContestant() {
                [...candidateListDiv.children].forEach(el => {
                    if (el.dataset.id === activeContestantId) el.classList.add('active');
                    else el.classList.remove('active');
                });
            }

            function selectContestant(id) {
                const c = contestants.find(x => x.id === id);
                if (!c) return;
                activeContestantId = id;
                highlightContestant();
                candDetails.style.display = 'flex';
                candNameEl.textContent = c.fullName || '(Unnamed)';
                candNumberEl.textContent = '#' + (c.number ?? '‚Äî');
                candAgeEl.textContent = c.age != null ? c.age : '‚Äî';
                candGenderEl.textContent = c.gender || '‚Äî';
                candRepEl.textContent = c.representing || '‚Äî';

                if (c.photoPath) {
                    candPhotoBox.style.display = 'block';
                    const img = document.createElement('img');
                    img.src = `/api/contestant-photo?eventId=${encodeURIComponent(eventId)}&contestantId=${encodeURIComponent(c.id)}`;
                    img.onload = () => {
                        if (img.naturalWidth <= 2 && img.naturalHeight <= 2) {
                            candPhotoBox.style.display = 'none';
                        } else {
                            candPhotoBox.innerHTML = '';
                            candPhotoBox.appendChild(img);
                        }
                    };
                    img.onerror = () => { candPhotoBox.style.display = 'none'; };
                } else {
                    candPhotoBox.style.display = 'none';
                    candPhotoBox.innerHTML = '';
                }

                restoreScoresForCurrent();
                updateProgress();
            }

            async function loadStructure() {
                try {
                    const { data: raw } = await api(`/api/structure?eventId=${encodeURIComponent(eventId)}`);
                    const rawPhases = pick(raw, 'phases', 'Phases') || [];
                    structure.phases = rawPhases.map(p => {
                        const seq = pick(p, 'sequence', 'Sequence');
                        const name = pick(p, 'name', 'Name') || '';
                        const segments = (pick(p, 'segments', 'Segments') || []).map(s => ({
                            sequence: pick(s, 'sequence', 'Sequence'),
                            name: pick(s, 'name', 'Name') || '',
                            criteria: (pick(s, 'criteria', 'Criteria') || []).map(cr => ({
                                name: pick(cr, 'name', 'Name') || '',
                                weight: Number(pick(cr, 'weight', 'Weight') ?? 0)
                            }))
                        }));
                        return {
                            sequence: seq,
                            key: seq != null ? 'P' + seq : 'IND-' + name.trim().toLowerCase().replace(/\s+/g, '_'),
                            name,
                            segments
                        };
                    });
                    buildPhaseSegments();
                } catch {
                    structure.phases = [];
                    buildPhaseSegments();
                }
            }

            function buildPhaseSegments() {
                phaseSegments = [];
                structure.phases.forEach(phase => {
                    if (phase.segments && phase.segments.length) {
                        phase.segments.forEach(seg => phaseSegments.push({ phase, segment: seg }));
                    } else {
                        phaseSegments.push({ phase: { key: 'NONE', name: 'No Phases', sequence: null, segments: [] }, segment: { sequence: 1, name: 'Empty', criteria: [] } });
                    }
                });
                if (!phaseSegments.length) {
                    phaseSegments.push({ phase: { key: 'NONE', name: 'No Phases', sequence: null, segments: [] }, segment: { sequence: 1, name: 'Empty', criteria: [] } });
                }
                currentIndex = 0;
                updatePhaseUI();
            }

            function updatePhaseUI() {
                const ps = phaseSegments[currentIndex];
                const phase = ps.phase, seg = ps.segment;
                const phaseText = phase.sequence != null ? `Phase ${phase.sequence}: ${phase.name}` : `Independent: ${phase.name}`;
                phaseLabel.textContent = phaseText;
                segmentLabel.textContent = `Segment ${seg.sequence}: ${seg.name}`;
                btnPrevPhase.disabled = currentIndex === 0;
                btnNextPhase.disabled = currentIndex === phaseSegments.length - 1;
                buildCriteriaCards();
                restoreScoresForCurrent();
                updateProgress();
            }

            btnPrevPhase.onclick = () => { if (currentIndex > 0) { currentIndex--; updatePhaseUI(); } };
            btnNextPhase.onclick = () => { if (currentIndex < phaseSegments.length - 1) { currentIndex++; updatePhaseUI(); } };
            window.addEventListener('keydown', e => {
                if (e.key === 'ArrowLeft') btnPrevPhase.click();
                else if (e.key === 'ArrowRight') btnNextPhase.click();
            });

            function buildCriteriaCards() {
                criteriaGrid.innerHTML = '';
                dirtySet.clear();
                inFlight.clear();
                const ps = phaseSegments[currentIndex];
                const phase = ps.phase, seg = ps.segment;
                (seg.criteria || []).forEach(cr => {
                    const criteriaKey = buildCriteriaKey(phase.key, seg.sequence, cr.name);
                    const card = document.createElement('div');
                    card.className = 'crit-card';
                    card.dataset.ckey = criteriaKey;
                    card.innerHTML = `
                                <h4>${escapeHtml(cr.name || 'Unnamed')}</h4>
                                <div class="crit-weight">Weight: ${cr.weight}%</div>
                                <input type="number" class="crit-input" placeholder="0-100" min="0" max="100" step="0.1">
                                <div style="display:flex; gap:8px;">
                                  <button class="crit-submit">Save</button>
                                  <button class="crit-retry" style="display:none;">Retry</button>
                                </div>
                                <div class="crit-status"></div>
                            `;
                    const input = card.querySelector('.crit-input');
                    const btnSave = card.querySelector('.crit-submit');
                    const btnRetry = card.querySelector('.crit-retry');
                    const status = card.querySelector('.crit-status');

                    input.addEventListener('input', () => {
                        if (inFlight.has(criteriaKey)) return;
                        status.textContent = 'Changed (not saved)';
                        status.className = 'crit-status dirty';
                        dirtySet.add(criteriaKey);
                        updateProgress();
                    });

                    async function doSave() {
                        if (!activeContestantId) {
                            status.textContent = 'Select contestant';
                            status.className = 'crit-status err';
                            return;
                        }
                        const val = parseFloat(input.value);
                        if (isNaN(val)) {
                            status.textContent = 'Enter score';
                            status.className = 'crit-status err';
                            return;
                        }
                        const dto = {
                            EventId: eventId,
                            ContestantId: activeContestantId,
                            JudgeId: judgeId,
                            PhaseId: phase.key,
                            SegmentId: 'S' + seg.sequence,
                            CriteriaId: criteriaKey,
                            RawValue: val,
                            MaxValue: 100
                        };

                        btnSave.disabled = true;
                        btnRetry.style.display = 'none';
                        inFlight.add(criteriaKey);
                        status.textContent = 'Saving...';
                        status.className = 'crit-status';
                        try {
                            const { ok, status: code, data } = await api('/api/score', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(dto)
                            });

                            let success = ok;
                            if (!success && data) {
                                const txt = JSON.stringify(data).toLowerCase();
                                if (txt.includes('"ok"') || txt.includes('"saved"') || txt.includes('"updated"')) {
                                    success = true;
                                }
                            }
                            if (!success && (code === 409)) success = true;

                            if (!success) {
                                try {
                                    await preloadScores();
                                    const persisted = scoreCache[activeContestantId] && (scoreCache[activeContestantId][criteriaKey] != null);
                                    if (persisted && Number(scoreCache[activeContestantId][criteriaKey]) === val) {
                                        success = true;
                                    }
                                } catch (e) { }
                            }

                            if (!success) throw new Error('Failed');

                            if (!scoreCache[activeContestantId]) scoreCache[activeContestantId] = {};
                            scoreCache[activeContestantId][criteriaKey] = val;
                            saveLocal(activeContestantId, criteriaKey, val);

                            status.textContent = 'Saved';
                            status.className = 'crit-status ok';
                            dirtySet.delete(criteriaKey);
                            updateProgress();
                            refreshScoresTable();

                            try {
                                if (window.chrome && window.chrome.webview && typeof window.chrome.webview.postMessage === 'function') {
                                    window.chrome.webview.postMessage({ type: 'score-saved', eventId, judgeId, contestantId: activeContestantId, criteriaKey });
                                }
                            } catch (e) { }
                        } catch (err) {
                            status.textContent = 'Error - not saved';
                            status.className = 'crit-status err';
                            btnRetry.style.display = 'inline-block';
                        } finally {
                            btnSave.disabled = false;
                            inFlight.delete(criteriaKey);
                        }
                    }

                    btnSave.onclick = doSave;
                    btnRetry.onclick = doSave;
                    criteriaGrid.appendChild(card);
                });
            }

            async function preloadScores() {
                try {
                    const { data: all } = await api(`/api/judge-all-scores?eventId=${encodeURIComponent(eventId)}&judgeId=${encodeURIComponent(judgeId)}`);
                    scoreCache = {};
                    (all || []).forEach(s => {
                        const cId = s.contestantId || s.ContestantId;
                        let critId = (s.criteriaId || s.CriteriaId || '').toLowerCase();
                        const parts = critId.split('::');
                        if (parts.length === 2) {
                            parts[0] = parts[0].toLowerCase();
                            critId = parts.join('::');
                        }
                        const raw = s.rawValue != null ? s.rawValue : s.RawValue;
                        if (!scoreCache[cId]) scoreCache[cId] = {};
                        scoreCache[cId][critId] = raw;
                        saveLocal(cId, critId, raw);
                    });
                } catch { }
            }

            function restoreScoresForCurrent(from = 'both') {
                if (!activeContestantId) return;
                const ps = phaseSegments[currentIndex];
                const phase = ps.phase, seg = ps.segment;
                const contestantMap = scoreCache[activeContestantId] || {};
                criteriaGrid.querySelectorAll('.crit-card').forEach(card => {
                    const input = card.querySelector('.crit-input');
                    const status = card.querySelector('.crit-status');
                    if (!input || !status) return;
                    const criteriaKey = card.dataset.ckey;
                    let value = null;

                    if (from !== 'local') {
                        if (contestantMap[criteriaKey] != null) value = contestantMap[criteriaKey];
                    }
                    if (value == null && from !== 'remote') {
                        value = getLocal(activeContestantId, criteriaKey);
                    }
                    if (value != null) {
                        input.value = value;
                        status.textContent = 'Saved';
                        status.className = 'crit-status ok';
                        dirtySet.delete(criteriaKey);
                    } else {
                        // FIX: Clear value if no score found
                        input.value = '';
                        status.textContent = 'No score yet';
                        status.className = 'crit-status';
                    }
                });
                updateProgress();
            }

            async function refreshScoresTable() {
                try {
                    const { data: rows } = await api(`/api/judge-progress?eventId=${encodeURIComponent(eventId)}&judgeId=${encodeURIComponent(judgeId)}`);
                    scoresBody.innerHTML = '';
                    rankedData = rows || []; // Store data for printing

                    let rank = 1;
                    (rows || []).forEach(r => {
                        const c = contestants.find(x => x.id === r.contestantId);
                        const label = c ? `#${c.number} ${c.fullName}` : (r.contestantId || '');
                        const pct = (Number(r.totalFraction || 0) * 100).toFixed(3);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${rank++}</td><td>${escapeHtml(label)}</td><td>${pct}</td>`;
                        scoresBody.appendChild(tr);
                    });
                    if (rank === 1) scoresBody.innerHTML = '<tr><td colspan="3">No scores yet.</td></tr>';
                } catch (err) {
                    scoresBody.innerHTML = '<tr><td colspan="3">Error</td></tr>';
                }
            }

            btnRefreshScores.onclick = refreshScoresTable;
            btnForceSync.onclick = async () => {
                await preloadScores();
                restoreScoresForCurrent('remote');
                refreshScoresTable();
            };
            btnRestoreLocal.onclick = () => { restoreScoresForCurrent('local'); };
            btnClearLocal.onclick = () => {
                if (!activeContestantId) return;
                if (!confirm('Clear locally stored (unsent) scores for this contestant on this judge?')) return;
                Object.keys(localStorage)
                    .filter(k => k.startsWith(`score:${eventId}:${judgeId}:${activeContestantId}:`))
                    .forEach(k => localStorage.removeItem(k));
                restoreScoresForCurrent();
            };
            btnReloadRemote.onclick = async () => {
                await preloadScores();
                restoreScoresForCurrent('remote');
            };

            function escapeHtml(s) {
                return (s || '').replace(/[&<>"']/g, c => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;'
                }[c]));
            }

            try {
                if (window.chrome && window.chrome.webview && window.chrome.webview.addEventListener) {
                    window.chrome.webview.addEventListener('message', ev => {
                        const d = ev.data;
                        if (!d || !d.type) return;
                        if (d.type === 'reloadRemote') {
                            preloadScores().then(() => { restoreScoresForCurrent('remote'); refreshScoresTable(); });
                        }
                        if (d.type === 'refreshScores') {
                            refreshScoresTable();
                        }
                    });
                }
            } catch (e) { }

            (async function init() {
                await loadEvent();
                await loadJudges();
                await loadStructure();
                await loadContestants();
                await preloadScores();
                updatePhaseUI();
                restoreScoresForCurrent();
                await refreshScoresTable();
                setInterval(async () => {
                    if (dirtySet.size === 0 && inFlight.size === 0) {
                        await preloadScores();
                        restoreScoresForCurrent('remote');
                        refreshScoresTable();
                    }
                }, 8000);
            })();
        })();
    </script>
</body>
</html>